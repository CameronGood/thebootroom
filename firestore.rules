rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Boots: public read, admin write only
    match /boots/{bootId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // Users: read/write own document only
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Quiz Sessions: create allowed, read/write if owner or no userId
    // Allow updates to link anonymous sessions to authenticated users
    match /quizSessions/{sessionId} {
      allow create: if true;
      allow read: if true; // Allow anyone to read sessions (needed for results page)
      allow update: if request.auth == null || 
        request.auth.uid == resource.data.userId || 
        request.auth.uid == request.resource.data.userId ||
        !('userId' in resource.data);
      allow delete: if request.auth == null || 
        request.auth.uid == resource.data.userId || 
        !('userId' in resource.data);
    }

    // Affiliate Clicks: read admin only, write via server/API only (not directly from client)
    match /affiliateClicks/{clickId} {
      allow read: if request.auth != null && request.auth.token.admin == true;
      allow write: if false; // Only via server/API
    }

    // Fitting Breakdowns: read/write own document only
    // Allow unauthenticated reads since API routes (using client SDK without auth context) validate userId in code
    // API routes verify the breakdown belongs to the requested user before returning it
    match /fittingBreakdowns/{docId} {
      allow read: if true; // API routes validate userId in path matches document userId
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Boot Fitters: public read, admin write only
    match /bootFitters/{fitterId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // Billing Metrics: read admin only, write via server/API only
    match /billingMetrics/{month} {
      allow read: if request.auth != null && request.auth.token.admin == true;
      allow write: if false; // Only via server/API (uses Admin SDK which bypasses rules)
    }
  }
}

